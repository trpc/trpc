name: PR title validator

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  pull-requests: read

jobs:
  main:
    name: Validate PR title
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          # Checkout the base branch to get the canonical package list
          # This works for both same-repo PRs and fork-based PRs
          ref: ${{ github.event.pull_request.base.ref }}
          repository: ${{ github.event.pull_request.base.repo.full_name }}

      - name: Extract package names
        id: extract-packages
        run: |
          # Additional scopes (comma-separated, easy to modify)
          ADDITIONAL_SCOPES="www,example,docs"

          # Extract package names from packages/* directory and remove @trpc/ prefix
          PACKAGES=$(find packages -maxdepth 2 -name "package.json" -type f \
              | while read -r file; do
                  jq -r '.name // empty' "$file" | sed 's/^@trpc\///'
              done | \
              grep -v '^$' | \
              sort -u)

          # Convert comma-separated additional scopes to newlines, then combine with packages
          ADDITIONAL_SCOPES_NL=$(echo "$ADDITIONAL_SCOPES" | tr ',' '\n')
          ALL_SCOPES=$(echo -e "$PACKAGES\n$ADDITIONAL_SCOPES_NL" | sort -u | tr '\n' '|' | sed 's/|$//')

          # Create regex pattern for single or multiple scopes
          # Pattern: (pkg1|pkg2|pkg3)(,(pkg1|pkg2|pkg3))*
          SCOPE_PATTERN="($ALL_SCOPES)(,($ALL_SCOPES))*"

          echo "scope_pattern=$SCOPE_PATTERN" >> $GITHUB_OUTPUT
          echo "Extracted scope pattern: $SCOPE_PATTERN"

      - uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Configure which scopes are allowed (newline-delimited).
          # These are regex patterns auto-wrapped in `^ $`.
          # Supports single scope (e.g., feat(client): ...) or multiple scopes (e.g., feat(client,server): ...)
          scopes: ${{ steps.extract-packages.outputs.scope_pattern }}
          # Scopes are optional by default (PRs can have no scope, single scope, or multiple scopes)
