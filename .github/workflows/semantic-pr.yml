name: PR title validator

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  pull-requests: read

jobs:
  main:
    name: Validate PR title
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          # Checkout the base branch to get the canonical package list
          # This works for both same-repo PRs and fork-based PRs
          ref: ${{ github.event.pull_request.base.ref }}
          repository: ${{ github.event.pull_request.base.repo.full_name }}

      - name: Validate PR title
        run: |
          # Additional scopes (comma-separated, easy to modify)
          ADDITIONAL_SCOPES="www,example,docs"

          # Extract package names from packages/* directory and remove @trpc/ prefix
          PACKAGES=$(find packages -maxdepth 2 -name "package.json" -type f \
              | while read -r file; do
                  jq -r '.name // empty' "$file" | sed 's/^@trpc\///'
              done | \
              grep -v '^$' | \
              sort -u)

          # Convert comma-separated additional scopes to newlines, then combine with packages
          ADDITIONAL_SCOPES_NL=$(echo "$ADDITIONAL_SCOPES" | tr ',' '\n')
          ALL_SCOPES=$(echo -e "$PACKAGES\n$ADDITIONAL_SCOPES_NL" | sort -u)

          # Get PR title
          PR_TITLE="${{ github.event.pull_request.title }}"

          echo "PR Title: $PR_TITLE"
          echo "Allowed scopes: $(echo "$ALL_SCOPES" | tr '\n' ', ' | sed 's/,$//')"

          # Validate Conventional Commits format: type(scope): subject
          # Pattern: type(scope): subject or type: subject (scope optional)
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+'; then
            echo "❌ PR title must follow Conventional Commits format: type(scope): subject"
            echo "   Examples: feat(client): add feature, fix(server): fix bug, docs: update docs"
            exit 1
          fi

          # Extract scope if present
          SCOPE=$(echo "$PR_TITLE" | sed -nE 's/^[^(]+\(([^)]+)\):.*/\1/p')

          if [ -n "$SCOPE" ]; then
            # Validate each scope in comma-separated list
            IFS=',' read -ra SCOPE_ARRAY <<< "$SCOPE"
            for scope_item in "${SCOPE_ARRAY[@]}"; do
              # Trim whitespace
              scope_item=$(echo "$scope_item" | xargs)
              
              # Check if scope is in allowed list
              if ! echo "$ALL_SCOPES" | grep -qFx "$scope_item"; then
                echo "❌ Invalid scope: '$scope_item'"
                echo "   Allowed scopes: $(echo "$ALL_SCOPES" | tr '\n' ', ' | sed 's/,$//')"
                exit 1
              fi
            done
            echo "✓ Scope(s) validated: $SCOPE"
          else
            echo "✓ No scope provided (optional)"
          fi

          echo "✅ PR title is valid"
